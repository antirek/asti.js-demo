<html>
  <head>
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="bower_components/asti.js/dist/asti.js"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    
  </head>
  <body>

    <div class="container">

      <div class="row">
        <div class="col-xs-6 col-md-4">
          <h4>Connection</h4>
          url: <input id="url" type="text" value="http://localhost:10000"><br/>
          identity: <input id="identity" type="text" value="vasya"><br/>
          <input id="connect" type="button" value="Connect">
        </div>

        <div class="col-xs-6 col-md-4">
          <h5>Originate call</h5>
          channel: <input id="channel" type="text" value="Local/6050@outbound1"><br/>
          context: <input id="context" type="text" value="outbound2"><br/>
          exten: <input id="exten" type="text" value="6000"><br/>
          tracking: <input id="tracking" type="text" value="6768435"><br/>
          <input id="originate" type="button" value="Originate">
        </div>
      </div>

      <div class="row">
        <div class="col-xs-6 col-md-4"> 

          <h5>Queues</h5>
          <input id="getQueues" type="button" value="getQueues">
          <div id="queues" style="height: 350px;overflow:auto;"></div>

        </div>
        <div class="col-xs-6 col-md-4"> 

          <h5>Agent events</h5>
          <div id="events" style="height: 350px;overflow:auto;"></div>

        </div>
      </div>
    
    </div>


    <script>
      var asti;

      $().ready(function () {
        $("#connect").on('click', function () {
          var url = $("#url").val();
          var identity = $("#identity").val();
          asti = new ASTI({url: url});
          asti.setIdentity({identity: identity}).connect();
        });

        $("#originate").on('click', function () {
          asti.call({
            channel: $("#channel").val(), 
            context: $("#context").val(),
            exten: $("#exten").val(),
            tracking: $("#tracking").val(),
          }, {
            onAnswer1Side: function (res) {
              alert('1 answer');
            },
            onAnswer2Side: function (res) {
              alert('2 answer');
            }
          })
          .then(function (response) {            
            //document.body.innerHTML = JSON.stringify(response);
          });
        });

        $("#getQueues").on('click', function (){
        asti.queue.list()
          .then(function (queueList) {
            queueList.forEach(function (queue) {
              $('#queues')
                .append(queue.queue)
                .append($('<div>', {
                    id: 'members' + queue.queue
                  })
                );
            });
          })
          .then(function () {
            return asti.queue.members();
          })
          .then(function (membersList) {
            membersList.forEach(function(member) {
              $("#members" + member.queue)
                .append(" -- " + member.location + " ")
                .append($('<button>', {
                    class: "subscribe", 
                    id: 'subscribe' + member.location, 
                    text: "subscribe", 
                    href: "#"})
                  .attr("data-agent", member.location)
                )
                .append("<br/>");
            });

            var handler = function (data) {
              console.log(data)
              $('#events')
                .prepend([
                    data.event,
                    data.agentcalled || data.member, 
                    data.queue,
                    data.calleridname, 
                    data.calleridnum,                    
                  ].join(" "))
                .prepend("<br/>");
            }

            $('.subscribe').on('click', function (evt) {
              asti.agent.subscribe({
                agent: $(evt.target).attr('data-agent')
              },{
                onAgentCalled: handler,
                onAgentConnect: handler,
                onAgentComplete: handler,
                onAgentRingNoAnswer: handler
              });
            });
          })

        });

      });
    </script>
  </body>
</html>